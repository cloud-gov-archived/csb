version: 1
name: cg-smtp
id: 260f2ead-b9e9-48b5-9a01-6e3097208ad7
description: SMTP service provided by Amazon Simple Email Service (SES)
display_name: SMTP (using AWS SES)
image_url: https://example.com/icon.jpg
documentation_url: https://aws.amazon.com/ses/ # todo
provider_display_name: ""
support_url: https://github.com/cloud-gov/csb/issues
tags: [aws, ses, smtp]
plans:
  - name: base
    id: 35ffb84b-a898-442e-b5f9-0a6a5229827d
    description: Provision SMTP credentials for sending email from your application.
    display_name: Send-only service
    bullets: # todo
      - information point 1
      - information point 2
      - some caveat here
    properties: # todo
      password_special_chars: '@/ \"?'
provision:
  plan_inputs:
  user_inputs:
    - field_name: domain
      type: string
      details: Domain to send mail from
      default: ""
    - field_name: dmarc_report_uri_aggregate
      type: string
      details: "The mailto URI to which DMARC aggregate reports should be sent. For example, 'mailto:dmarc@example.gov'."
      default: ""
    - field_name: dmarc_report_uri_failure
      type: string
      details: "To mailto URI to which to which DMARC individual message failure reports should be sent. For example, 'mailto:dmarc@example.gov'."
      default: ""
    - field_name: enable_feedback_notifications
      type: boolean
      details: Flag to toggle creation of SNS topics for feedback notifications
      default: false
    - field_name: mail_from_subdomain
      type: string
      details: Subdomain to use as sending email server
      default: ""
  computed_inputs:
    - name: aws_access_key_id_govcloud
      type: string
      default: ${config("aws.govcloud.access_key_id")}
    - name: aws_secret_access_key_govcloud
      type: string
      default: ${config("aws.govcloud.secret_access_key")}
    - name: aws_region_govcloud
      type: string
      default: ${config("aws.govcloud.region")}
    - name: aws_access_key_id_commercial
      type: string
      default: ${config("aws.commercial.access_key_id")}
    - name: aws_secret_access_key_commercial
      type: string
      default: ${config("aws.commercial.secret_access_key")}
    - name: aws_region_commercial
      type: string
      default: ${config("aws.commercial.region")}
    - name: default_domain
      overwrite: true
      type: string
      default: ${config("aws.zone")}
    - name: labels
      default: ${json.marshal(request.default_labels)}
      overwrite: true
      type: object
    - name: instance_name
      type: string
      default: ${request.instance_id}
    # Inputs used for tagging resources
    - name: organization_guid
      type: string
      default: ${request.context.organization_guid}
    - name: organization_name
      type: string
      default: ${request.context.organization_name}
    - name: space_guid
      type: string
      default: ${request.context.space_guid}
    - name: space_name
      type: string
      default: ${request.context.space_name}
  outputs:
    - field_name: region
      type: string
      details: AWS region for the SES instance
    - field_name: required_records
      type: object
      details: If a domain was supplied, the records to be created in that zone
    - field_name: dmarc_report_uri_aggregate
      type: string
      details: "The mailto URI to which DMARC aggregate reports should be sent. For example, 'mailto:dmarc@example.gov'."
    - field_name: dmarc_report_uri_failure
      type: string
      details: "To mailto URI to which to which DMARC individual message failure reports should be sent. For example, 'mailto:dmarc@example.gov'."
    - field_name: instructions
      type: string
      details: Any further steps are needed before using the service.
    - field_name: domain_arn
      type: string
      details: Instance SES domain identity (used when creating bindings)
    - field_name: bounce_topic_arn
      type: string
      details: ARN of the SNS topic receiving bounce feedback notifications
    - field_name: complaint_topic_arn
      type: string
      details: ARN of the SNS topic receiving complaint feedback notifications
    - field_name: delivery_topic_arn
      type: string
      details: ARN of the SNS topic receiving delivery feedback notifications
  template_refs:
    main: terraform/provision/main.tf
    notification: terraform/provision/notification.tf
    outputs: terraform/provision/outputs.tf
    providers: terraform/provision/providers.tf
    variables: terraform/provision/variables.tf
    verification: terraform/provision/verification.tf
    versions: terraform/provision/versions.tf
bind:
  plan_inputs: []
  user_inputs:
    - field_name: source_ips
      type: array
      default:
        - 52.222.122.97/32
        - 52.222.123.172/32
      details: IP Ranges that requests to SES must come from
      prohibit_update: false
    - field_name: notification_webhook
      type: string
      details: HTTPS endpoint to subscribe to feedback notifications
      default: ""
  computed_inputs:
    - name: aws_access_key_id_govcloud
      type: string
      default: ${config("aws.govcloud.access_key_id")}
    - name: aws_secret_access_key_govcloud
      type: string
      default: ${config("aws.govcloud.secret_access_key")}
    - name: aws_region_govcloud
      type: string
      default: ${config("aws.govcloud.region")}
    - name: region
      default: ${instance.details["region"]}
      overwrite: true
      type: string
    - name: domain_arn
      default: ${instance.details["domain_arn"]}
      overwrite: true
      type: string
    - name: user_name
      default: csb-${instance.name}-${request.binding_id}
      overwrite: true
      type: string
    - name: instance_name
      type: string
      default: ${request.instance_id}
    - name: bounce_topic_arn
      default: ${instance.details["bounce_topic_arn"]}
      overwrite: true
      type: string
    - name: complaint_topic_arn
      default: ${instance.details["complaint_topic_arn"]}
      overwrite: true
      type: string
    - name: delivery_topic_arn
      default: ${instance.details["delivery_topic_arn"]}
      overwrite: true
      type: string
  outputs:
    - field_name: smtp_server
      type: string
      details: SMTP server
    - field_name: smtp_user
      type: string
      details: SMTP user and AWS Access Key ID
    - field_name: smtp_password
      type: string
      details: SMTP password
    - field_name: aws_access_key_id
      type: string
      details: AWS Access Key ID
    - field_name: aws_secret_access_key
      type: string
      details: AWS Secret Access Key
    - field_name: notification_webhook
      type: string
      details: Subscribed endpoint for email feedback notifications
  template_refs:
    main: terraform/bind/main.tf
    outputs: terraform/bind/outputs.tf
    provider: terraform/bind/provider.tf
    variables: terraform/bind/variables.tf
    versions: terraform/bind/versions.tf
examples:
  - name: smtp
    description: SMTP base
    plan_id: 35ffb84b-a898-442e-b5f9-0a6a5229827d
    provision_params: {}
    bind_params: {}
plan_updateable: false
requiredenvvars: []
